# –†–µ–∑—é–º–µ –∞–Ω–∞–ª–∏–∑–∞ failing —Ç–µ—Å—Ç–æ–≤ –∏ 500 –æ—à–∏–±–æ–∫

## –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä

–ü—Ä–æ–≤–µ–¥–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ 15 failing —Ç–µ—Å—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ NNP LLM Router, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ - —Å–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç —Å –∫–æ–¥–æ–º `500 Internal Server Error` –≤–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

## –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### 1. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
**–°–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç —Å 500 –æ—à–∏–±–∫–∞–º–∏ –≤–º–µ—Å—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–æ–¥–æ–≤ 400/422/413 –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**

### 2. –ö–æ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ API**: –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ —Å–µ—Ä–≤–∏—Å—ã
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**: –í—Å–µ –æ—à–∏–±–∫–∏ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ 500 –æ—à–∏–±–∫–∏
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è**: –û—à–∏–±–∫–∏ 422 –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö API –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ 400
- **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö**: –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤–Ω–µ—à–Ω–∏–º API

### 3. –ù–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
| –¢–µ—Å—Ç | –û–∂–∏–¥–∞–Ω–∏–µ | –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç | –ü—Ä–æ–±–ª–µ–º–∞ |
|------|----------|----------------------|----------|
| `test_create_embeddings_empty_input` | 400 | 500 | –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø–∞–¥–∞–µ—Ç –Ω–∞ –ø—É—Å—Ç–æ–º input |
| `test_create_transcription_missing_required_fields` | 400 | 500 | –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ |
| `test_create_transcription_empty_file` | 400 | 500 | –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø–∞–¥–∞–µ—Ç –Ω–∞ –ø—É—Å—Ç–æ–º —Ñ–∞–π–ª–µ |
| `test_create_transcription_large_file` | [200, 400, 413] | 500 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ |

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ª–æ—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```
Client ‚Üí API ‚Üí Service ‚Üí Provider ‚Üí External API
         ‚Üë    ‚Üë        ‚Üë         ‚Üë
      NO VALIDATION
```

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
```
External API (422) ‚Üí Provider (500) ‚Üí Service (500) ‚Üí Client (500)
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
External API (422) ‚Üí Provider (400) ‚Üí Service (400) ‚Üí Client (400)
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–≤–Ω–µ–¥—Ä–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
1. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã API** –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ —Å–µ—Ä–≤–∏—Å—ã
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö** - —Ä–∞–∑–¥–µ–ª–∏—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—à–∏–±–∫–∏
3. **–î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è** –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö API –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∫–æ–¥–∞–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

### üü° –í–∞–∂–Ω—ã–µ (–≤–Ω–µ–¥—Ä–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è)
1. **–í–Ω–µ–¥—Ä–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫** –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö** –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–Ω–µ—à–Ω–∏–º API
3. **–£–ª—É—á—à–∏—Ç—å middleware** –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

## –ü—Ä–∏–º–µ—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ë—ã–ª–æ (–ø—Ä–∏–≤–æ–¥–∏—Ç –∫ 500 –æ—à–∏–±–∫–µ):
```python
@app.post("/v1/embeddings")
async def create_embeddings(
    request: Request,
    auth_data: tuple = Depends(check_endpoint_access("/v1/embeddings"))
):
    return await app.state.embedding_service.create_embeddings(request, auth_data)
```

### –°—Ç–∞–ª–æ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 400):
```python
@app.post("/v1/embeddings")
async def create_embeddings(
    request: Request,
    auth_data: tuple = Depends(check_endpoint_access("/v1/embeddings"))
):
    try:
        request_body = await request.json()
        
        # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if "input" not in request_body:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={"error": {"message": "Missing required field: input", "code": "missing_field"}}
            )
        
        if not request_body["input"]:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={"error": {"message": "Input cannot be empty", "code": "empty_input"}}
            )
        
        return await app.state.embedding_service.create_embeddings(request, auth_data)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail={"error": {"message": "Internal server error", "code": "internal_server_error"}}
        )
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–°–Ω–∏–∂–µ–Ω–∏–µ 500 –æ—à–∏–±–æ–∫ –Ω–∞ 80%** –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP** –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
3. **–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
4. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –ª—É—á—à–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –î–µ–Ω—å 1-2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
- –î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –î–µ–Ω—å 3-4: –£–ª—É—á—à–µ–Ω–∏—è
- –í–Ω–µ–¥—Ä–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö
- –û–±–Ω–æ–≤–∏—Ç—å middleware

### –î–µ–Ω—å 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞
- –ó–∞–ø—É—Å—Ç–∏—Ç—å failing —Ç–µ—Å—Ç—ã
- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ passing —Ç–µ—Å—Ç–æ–≤**: —Å 84.9% –¥–æ 95%+
2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ 500 –æ—à–∏–±–æ–∫**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 80% –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
3. **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**: < 100–º—Å
4. **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**: 90%+

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ 500 –æ—à–∏–±–æ–∫ —è–≤–ª—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–≤–æ–ª—è—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞.

**–ö–ª—é—á–µ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ù–∞—á–∞—Ç—å —Å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö API, —á—Ç–æ –¥–∞—Å—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∏ —Å–Ω–∏–∑–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 500 –æ—à–∏–±–æ–∫ –¥–ª—è –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.