# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º —Å 500 –æ—à–∏–±–∫–∞–º–∏

## –û–±–∑–æ—Ä

–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –∏ failing —Ç–µ—Å—Ç–æ–≤, –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º, –ø—Ä–∏–≤–æ–¥—è—â–∏—Ö –∫ 500 –æ—à–∏–±–∫–∞–º –≤–º–µ—Å—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP.

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã)
1. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ API
2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è)
1. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö
2. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
3. –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
1. –£–ª—É—á—à–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
2. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ Pydantic –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. –£–ª—É—á—à–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API

## –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ API

#### –ü—Ä–æ–±–ª–µ–º–∞:
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–≤–∏—á–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö API.

#### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ —Å–µ—Ä–≤–∏—Å—ã.

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è Chat Completions:

```python
# src/api/validation.py
from pydantic import BaseModel, Field, validator
from typing import List, Optional, Any, Dict
from fastapi import HTTPException, status

class MessageModel(BaseModel):
    role: str
    content: str
    
    @validator('role')
    def validate_role(cls, v):
        if v not in ['system', 'user', 'assistant']:
            raise ValueError(f"Invalid role: {v}")
        return v

class ChatCompletionRequest(BaseModel):
    model: str
    messages: List[MessageModel]
    stream: bool = False
    max_tokens: Optional[int] = None
    temperature: Optional[float] = Field(None, ge=0.0, le=2.0)
    
    @validator('messages')
    def validate_messages(cls, v):
        if not v:
            raise ValueError("Messages cannot be empty")
        return v

# src/api/main.py
from .validation import ChatCompletionRequest

@app.post("/v1/chat/completions")
async def chat_completions(
    request: Request,
    auth_data: tuple = Depends(check_endpoint_access("/v1/chat/completions"))
):
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        request_body = await request.json()
        validated_request = ChatCompletionRequest(**request_body)
        
        # –ü–µ—Ä–µ–¥–∞—á–∞ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Ä–≤–∏—Å
        return await app.state.chat_service.chat_completions(validated_request.dict(), auth_data)
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={"error": {"message": str(e), "code": "validation_error"}}
        )
```

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è Embeddings:

```python
# src/api/validation.py
class EmbeddingRequest(BaseModel):
    model: str
    input: List[str]
    encoding_format: str = "float"
    
    @validator('input')
    def validate_input(cls, v):
        if not v:
            raise ValueError("Input cannot be empty")
        if not all(isinstance(item, str) for item in v):
            raise ValueError("All input items must be strings")
        return v

# src/api/main.py
@app.post("/v1/embeddings")
async def create_embeddings(
    request: Request,
    auth_data: tuple = Depends(check_endpoint_access("/v1/embeddings"))
):
    try:
        request_body = await request.json()
        validated_request = EmbeddingRequest(**request_body)
        
        return await app.state.embedding_service.create_embeddings(validated_request.dict(), auth_data)
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={"error": {"message": str(e), "code": "validation_error"}}
        )
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

#### –ü—Ä–æ–±–ª–µ–º–∞:
–í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ "–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ" –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 500 –æ—à–∏–±–∫—É.

#### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è Chat Service:

```python
# src/services/chat_service/chat_service.py
from fastapi import HTTPException, status
from pydantic import ValidationError

class ChatService:
    async def chat_completions(self, request_body: Dict[str, Any], auth_data: Tuple[str, str, list, list]) -> Any:
        try:
            # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
            pass
        except ValidationError as e:
            # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={"error": {"message": f"Validation error: {e}", "code": "validation_error"}}
            )
        except KeyError as e:
            # –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={"error": {"message": f"Missing required field: {e}", "code": "missing_field"}}
            )
        except ValueError as e:
            # –ù–µ–≤–µ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail={"error": {"message": f"Invalid field value: {e}", "code": "invalid_field_value"}}
            )
        except HTTPException as e:
            # HTTP –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            raise e
        except Exception as e:
            # –¢–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ 500
            logger.error(f"Unexpected error in chat_completions: {e}", exc_info=True)
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail={"error": {"message": "Internal server error", "code": "internal_server_error"}}
            )
```

### 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP

#### –ü—Ä–æ–±–ª–µ–º–∞:
–í–Ω–µ—à–Ω–∏–µ API –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 422 –æ—à–∏–±–∫–∏, –Ω–æ —Å–µ—Ä–≤–∏—Å –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ 400.

#### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö API –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∫–æ–¥–∞–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```python
# src/core/error_mapping.py
from httpx import HTTPStatusError

class ErrorMapper:
    @staticmethod
    def map_provider_error(status_code: int, error_message: str) -> tuple:
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∫–æ–¥ –æ—à–∏–±–∫–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        
        Returns:
            tuple: (status_code, error_detail)
        """
        # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ 400
        if status_code == 422:
            return 400, {"error": {"message": error_message, "code": "validation_error"}}
        
        # –û—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        if status_code == 401:
            return 401, {"error": {"message": "Provider authentication failed", "code": "provider_auth_error"}}
        
        # –û—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        if status_code == 403:
            return 403, {"error": {"message": "Provider access denied", "code": "provider_access_denied"}}
        
        # –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        if status_code == 404:
            return 404, {"error": {"message": "Model not found", "code": "model_not_found"}}
        
        # –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –∑–∞–ø—Ä–æ—Å
        if status_code == 413:
            return 413, {"error": {"message": "Request too large", "code": "request_too_large"}}
        
        # –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
        if status_code == 429:
            return 429, {"error": {"message": "Rate limit exceeded", "code": "rate_limit_exceeded"}}
        
        # –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        if status_code >= 500:
            return 502, {"error": {"message": "Provider server error", "code": "provider_server_error"}}
        
        # –î—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏
        if 400 <= status_code < 500:
            return 400, {"error": {"message": error_message, "code": f"provider_error_{status_code}"}}
        
        # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
        return 500, {"error": {"message": "Unknown provider error", "code": "unknown_provider_error"}}

# src/providers/openai.py
from ..core.error_mapping import ErrorMapper

async def embeddings(self, request_body: Dict[str, Any], provider_model_name: str, model_config: Dict[str, Any]) -> Any:
    try:
        # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
        pass
    except httpx.HTTPStatusError as e:
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–¥—ã
        mapped_status, error_detail = ErrorMapper.map_provider_error(
            e.response.status_code, 
            f"Provider error: {e.response.text}"
        )
        raise HTTPException(status_code=mapped_status, detail=error_detail)
```

### 4. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

#### –ü—Ä–æ–±–ª–µ–º–∞:
–ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ –ø–æ-—Å–≤–æ–µ–º—É.

#### –†–µ—à–µ–Ω–∏–µ:
–°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫.

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```python
# src/core/error_handler.py
from fastapi import HTTPException, status
from typing import Any, Dict
import logging

logger = logging.getLogger("nnp-llm-router")

class ErrorHandler:
    @staticmethod
    def handle_validation_error(error: Exception, context: Dict[str, Any] = None) -> HTTPException:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        error_detail = {
            "error": {
                "message": str(error),
                "code": "validation_error",
                "context": context or {}
            }
        }
        logger.warning(f"Validation error: {error}", extra={"error_detail": error_detail})
        return HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=error_detail
        )
    
    @staticmethod
    def handle_provider_error(error: Exception, context: Dict[str, Any] = None) -> HTTPException:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"""
        error_detail = {
            "error": {
                "message": str(error),
                "code": "provider_error",
                "context": context or {}
            }
        }
        logger.error(f"Provider error: {error}", extra={"error_detail": error_detail})
        return HTTPException(
            status_code=status.HTTP_502_BAD_GATEWAY,
            detail=error_detail
        )
    
    @staticmethod
    def handle_unexpected_error(error: Exception, context: Dict[str, Any] = None) -> HTTPException:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫"""
        error_detail = {
            "error": {
                "message": "Internal server error",
                "code": "internal_server_error"
            }
        }
        logger.error(f"Unexpected error: {error}", extra={"error_detail": error_detail}, exc_info=True)
        return HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=error_detail
        )

# src/services/chat_service/chat_service.py
from ..core.error_handler import ErrorHandler

class ChatService:
    async def chat_completions(self, request_body: Dict[str, Any], auth_data: Tuple[str, str, list, list]) -> Any:
        try:
            # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
            pass
        except ValidationError as e:
            raise ErrorHandler.handle_validation_error(e, {"service": "chat_completions"})
        except ProviderAPIError as e:
            raise ErrorHandler.handle_provider_error(e, {"service": "chat_completions"})
        except Exception as e:
            raise ErrorHandler.handle_unexpected_error(e, {"service": "chat_completions"})
```

### 5. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö

#### –ü—Ä–æ–±–ª–µ–º–∞:
–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç –¥–æ–ª–∂–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

#### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–æ–≤.

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```python
# src/providers/openai.py
async def embeddings(self, request_body: Dict[str, Any], provider_model_name: str, model_config: Dict[str, Any]) -> Any:
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if "input" not in request_body:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={"error": {"message": "Missing required field: input", "code": "missing_field"}}
        )
    
    input_data = request_body["input"]
    if not input_data:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={"error": {"message": "Input cannot be empty", "code": "empty_input"}}
        )
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if isinstance(input_data, list) and len(input_data) > 1000:
        raise HTTPException(
            status_code=status.HTTP_413_REQUEST_ENTITY_TOO_LARGE,
            detail={"error": {"message": "Input too large (max 1000 items)", "code": "input_too_large"}}
        )
    
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
    pass

async def transcriptions(
    self,
    audio_data: bytes,
    filename: str,
    content_type: str,
    model_id: str,
    **kwargs
) -> Dict[str, Any]:
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if not audio_data:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={"error": {"message": "Audio file cannot be empty", "code": "empty_file"}}
        )
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25MB –º–∞–∫—Å–∏–º—É–º)
    max_file_size = 25 * 1024 * 1024  # 25MB
    if len(audio_data) > max_file_size:
        raise HTTPException(
            status_code=status.HTTP_413_REQUEST_ENTITY_TOO_LARGE,
            detail={"error": {"message": "Audio file too large (max 25MB)", "code": "file_too_large"}}
        )
    
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
    pass
```

### 6. –£–ª—É—á—à–µ–Ω–∏–µ middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

#### –ü—Ä–æ–±–ª–µ–º–∞:
Middleware –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π.

#### –†–µ—à–µ–Ω–∏–µ:
–£–ª—É—á—à–∏—Ç—å middleware –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```python
# src/api/middleware.py
from fastapi import Request, HTTPException, status
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.responses import JSONResponse
import logging

logger = logging.getLogger("nnp-llm-router")

class ErrorHandlerMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        try:
            response = await call_next(request)
            return response
        except HTTPException as e:
            # HTTP –∏—Å–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            return JSONResponse(
                status_code=e.status_code,
                content=e.detail
            )
        except ValueError as e:
            # –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            logger.warning(f"Validation error: {e}", extra={"request_id": getattr(request.state, 'request_id', None)})
            return JSONResponse(
                status_code=status.HTTP_400_BAD_REQUEST,
                content={"error": {"message": str(e), "code": "validation_error"}}
            )
        except Exception as e:
            # –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
            request_id = getattr(request.state, 'request_id', None)
            logger.error(f"Unexpected error: {e}", extra={"request_id": request_id}, exc_info=True)
            return JSONResponse(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                content={"error": {"message": "Internal server error", "code": "internal_server_error"}}
            )

# src/api/main.py
app.add_middleware(ErrorHandlerMiddleware)
app.add_middleware(RequestLoggerMiddleware)
```

## –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –¥–Ω—è)
1. –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã API
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
3. –î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### –≠—Ç–∞–ø 2: –£–ª—É—á—à–µ–Ω–∏—è (2-3 –¥–Ω—è)
1. –í–Ω–µ–¥—Ä–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
2. –£–ª—É—á—à–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö
3. –û–±–Ω–æ–≤–∏—Ç—å middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### –≠—Ç–∞–ø 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (1-2 –¥–Ω—è)
1. –í–Ω–µ–¥—Ä–∏—Ç—å Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. –£–ª—É—á—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
3. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. **–°–Ω–∏–∂–µ–Ω–∏–µ 500 –æ—à–∏–±–æ–∫**: –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
2. **–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞**: –ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
3. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏**: –õ—É—á—à–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
4. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ REST –ø—Ä–∏–Ω—Ü–∏–ø–∞–º**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
5. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞**: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–∞–¥–µ–Ω–∏–π –Ω–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö –æ—à–∏–±–∫–∞—Ö

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å failing —Ç–µ—Å—Ç—ã –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
2. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—Ç —Ä–µ—à–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É 500 –æ—à–∏–±–æ–∫ –ø—É—Ç–µ–º –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞.