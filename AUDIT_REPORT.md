# üîç –ê—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ LLM Router - –û—Ç—á–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å—Ç—Ä–∏–º–∏–Ω–≥–∞

## üìã –†–µ–∑—é–º–µ

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-10-03  
**–¶–µ–ª—å:** –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –æ–±—Ä—ã–≤–∞ —Å—Ç—Ä–∏–º–∞ –ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö –≤ OpenWebUI  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø - –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö

---

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### 1. ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –†–∞–∑—Ä—ã–≤ –º–Ω–æ–≥–æ–±–∞–π—Ç–Ω—ã—Ö UTF-8 —Å–∏–º–≤–æ–ª–æ–≤ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏

**–§–∞–π–ª:** [`src/services/chat_service.py:163`](src/services/chat_service.py:163)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
decoded_chunk = chunk.decode('utf-8')  # ‚ùå –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ UTF-8 —Å–∏–º–≤–æ–ª–∞
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- HTTP —á–∞–Ω–∫–∏ –º–æ–≥—É—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç—å –º–Ω–æ–≥–æ–±–∞–π—Ç–Ω—ã–π UTF-8 —Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, emoji, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã)
- –°–∏–º–≤–æ–ª '–π' = `0xD0 0xB9` (2 –±–∞–π—Ç–∞)
- –ï—Å–ª–∏ —á–∞–Ω–∫ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `0xD0`, –∞ `0xB9` –≤ —Å–ª–µ–¥—É—é—â–µ–º - `UnicodeDecodeError`
- –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ: **–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —á–∞–Ω–∫** (—Å—Ç—Ä–æ–∫–∞ 179) ‚Üí **–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö**

**–í–ª–∏—è–Ω–∏–µ:**
- ‚úÖ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç: —Ä–∞–±–æ—Ç–∞–µ—Ç (1 –±–∞–π—Ç –Ω–∞ —Å–∏–º–≤–æ–ª)
- ‚ùå –†—É—Å—Å–∫–∏–π/Unicode: –æ–±—Ä—ã–≤—ã —Å—Ç—Ä–∏–º–∞ –ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö
- ‚ùå Emoji –≤ –æ—Ç–≤–µ—Ç–∞—Ö: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä—ã–≤—ã
- ‚ùå OpenWebUI —Å –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏: –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Çeful –¥–µ–∫–æ–¥–µ—Ä —Å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–µ–π
decoder = codecs.getincrementaldecoder('utf-8')(errors='ignore')
decoded_chunk = decoder.decode(chunk, final=False)
```

---

### 2. ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö SSE/JSON —Å—Ç—Ä–æ–∫

**–§–∞–π–ª:** [`src/services/chat_service.py:165-173`](src/services/chat_service.py:165-173)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
if decoded_chunk.startswith('data: '):
    full_content, stream_completed_usage = self._process_openai_sse_chunk(...)
    yield chunk  # ‚ùå –ß—Ç–æ –µ—Å–ª–∏ 'data: ' —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏?
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–ª–æ–º–∫–∏:**
```
Chunk 1: "data: {\"id\":\"123\",\"cho"
Chunk 2: "ices\":[{\"delta\":{\"content\":\"Hi\"}}]}\n\n"
```
- Chunk 1 –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–æ–ª–Ω–æ–≥–æ SSE —Å–æ–±—ã—Ç–∏—è ‚Üí –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- Chunk 2 –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'data: ' ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

**–í–ª–∏—è–Ω–∏–µ:**
- –ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–±–æ–ª—å—à–∏–µ —á–∞–Ω–∫–∏) - —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö/–¥–∞–ª—å–Ω–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö (–º–∞–ª—ã–µ —á–∞–Ω–∫–∏) - –æ–±—Ä—ã–≤—ã
- OpenWebUI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–ª–∏ –∑–∞–≤–∏—Å–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–ø–æ–ª–Ω—ã—Ö —Å—Ç—Ä–æ–∫:
```python
buffer = b""
async for chunk in response_data.body_iterator:
    buffer += chunk
    lines = buffer.split(b'\n\n')
    buffer = lines[-1]  # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É
    for line in lines[:-1]:
        # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–µ SSE —Å–æ–±—ã—Ç–∏—è
```

---

### 3. ‚ö†Ô∏è –í–´–°–û–ö–ò–ô: JSON parsing –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è Ollama

**–§–∞–π–ª:** [`src/services/chat_service.py:223-264`](src/services/chat_service.py:223-264)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
def _process_ollama_chunk(...):
    for line in decoded_chunk.split('\n'):
        data = json.loads(line)  # ‚ùå –£–ø–∞–¥–µ—Ç –µ—Å–ª–∏ JSON —Ä–∞–∑–æ—Ä–≤–∞–Ω
```

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
Chunk 1: "{\"message\":{\"role\":\"assistant\",\"cont"
Chunk 2: "ent\":\"Hello\"},\"done\":false}\n"
```

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- `JSONDecodeError` ‚Üí —Å—Ç—Ä–∏–º –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è (—Å—Ç—Ä–æ–∫–∞ 183)
- –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É + `[DONE]` ‚Üí –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:**
–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è NDJSON:
```python
json_buffer = ""
for line in lines:
    json_buffer += line
    try:
        data = json.loads(json_buffer)
        json_buffer = ""  # –£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª–∏
        # –æ–±—Ä–∞–±–æ—Ç–∫–∞...
    except json.JSONDecodeError:
        continue  # –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–≤–ª–∏—è—é—Ç –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)

### 4. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Å—Ç—Ä–∏–º–µ

**–§–∞–π–ª:** [`src/services/chat_service.py:180-202`](src/services/chat_service.py:180-202)

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. –ü—Ä–∏ `JSONDecodeError` ‚Üí `yield error` + `break` ‚Üí –Ω–æ –ø–æ—Ç–æ–º `yield [DONE]`
2. OpenWebUI –º–æ–∂–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –∫–∞–∫ —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
3. –û—à–∏–±–∫–∞ –≤ SSE —Ñ–æ—Ä–º–∞—Ç–µ (—Å—Ç—Ä–æ–∫–∞ 310) –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É OpenAI

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å [DONE] –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
stream_error = False
try:
    # stream processing
except:
    stream_error = True
    yield error
    
if not stream_error:
    yield b"data: [DONE]\n\n"
```

---

### 5. –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ç–∏–ø–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**–§–∞–π–ª:** [`src/services/chat_service.py:165-175`](src/services/chat_service.py:165-175)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
if decoded_chunk.startswith('data: '):
    # OpenAI SSE
elif provider_type == "ollama":
    # Ollama NDJSON
else:
    yield chunk  # ‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
```

**–†–∏—Å–∫–∏:**
- –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–¥–∞–µ—Ç —Å–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è
- Anthropic –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —Ñ–æ—Ä–º–∞—Ç ‚Üí –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
Explicit format detection:
```python
# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –ø–æ –ø–µ—Ä–≤–æ–º—É —á–∞–Ω–∫—É
if not format_detected:
    if b'data:' in chunk:
        stream_format = 'sse'
    else:
        stream_format = 'ndjson'
```

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ SSE —Ñ–æ—Ä–º–∞—Ç–∞

**–§–∞–π–ª:** [`src/services/chat_service.py:204-221`](src/services/chat_service.py:204-221)

**–ü—Ä–æ–±–ª–µ–º–∞:**
SSE –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- `data: [DONE]` ‚úÖ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- `data: {"error": {...}}` ‚ùå –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- `:comment\n` (SSE –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π) ‚ùå –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- `event: message\ndata: {...}` ‚ùå –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–í–ª–∏—è–Ω–∏–µ:**
–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (OpenRouter, Anthropic) –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π SSE ‚Üí –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞

---

### 7. –¢–∞–π–º–∞—É—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º–∏

**–§–∞–π–ª—ã:** 
- [`src/providers/openai.py:33`](src/providers/openai.py:33)
- [`src/providers/base.py:32`](src/providers/base.py:32)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
timeout=600  # 10 –º–∏–Ω—É—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–†–∏—Å–∫–∏:**
- –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∑–∞–≤–∏—Å–Ω–µ—Ç ‚Üí –∫–ª–∏–µ–Ω—Ç –∂–¥–µ—Ç 10 –º–∏–Ω—É—Ç
- OpenWebUI –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ ‚Üí –∑–∞–≤–∏—Å—à–∏–π —Å—Ç—Ä–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ù–µ—Ç —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É streaming –∏ non-streaming —Ç–∞–π–º–∞—É—Ç–∞–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
# Non-streaming: 60 —Å–µ–∫—É–Ω–¥
# Streaming: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç) –∏–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π
timeout = 300 if stream else 60
```

---

## üîß –ü—Ä–æ–±–ª–µ–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è)

### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ backpressure –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –º–µ–¥–ª–µ–Ω–Ω–æ —á–∏—Ç–∞–µ—Ç, –∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –±—ã—Å—Ç—Ä–æ –æ—Ç–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.Queue` —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞

---

### 9. –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ "–∑–¥–æ—Ä–æ–≤—å—è" —Å—Ç—Ä–∏–º–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å:
- –°–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –ø–æ—Ç–µ—Ä—è–Ω–æ –∏–∑-–∑–∞ UnicodeDecodeError
- –°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∏–º–æ–≤ –æ–±–æ—Ä–≤–∞–ª–∏—Å—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–æ–≤ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
```python
stream_metrics = {
    "chunks_processed": 0,
    "chunks_failed": 0,
    "bytes_received": 0,
    "unicode_errors": 0
}
```

---

### 10. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å OpenAI API

**–§–∞–π–ª:** [`src/services/chat_service.py:288-310`](src/services/chat_service.py:288-310)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
"object": "chat.completion.chunk",  # ‚ùå
"choices": [],                       # ‚ùå
"error": {...}                       # ‚úÖ –ù–æ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ
```

**OpenAI —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è streaming –æ—à–∏–±–æ–∫:**
```python
# –û—à–∏–±–∫–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ chunk –æ–±—ä–µ–∫—Ç–µ
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º SSE —Å–æ–±—ã—Ç–∏–µ–º
data: {"error": {"message": "...", "type": "...", "code": "..."}}
```

---

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### üî¥ –ö–†–ò–¢–ò–ß–ù–û (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
1. ‚úÖ UTF-8 incremental decoder
2. ‚úÖ SSE/JSON –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–ø–æ–ª–Ω—ã—Ö —Å—Ç—Ä–æ–∫
3. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å [DONE])

### üü° –í–ê–ñ–ù–û (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):
4. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Å—Ç—Ä–∏–º–∞
5. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è SSE —Ñ–æ—Ä–º–∞—Ç–∞
6. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (backlog):
7. ‚úÖ Backpressure –º–µ—Ö–∞–Ω–∏–∑–º
8. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
9. ‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å OpenAI error format

---

## üõ†Ô∏è –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –¥–Ω—è)
```mermaid
graph LR
    A[–î–æ–±–∞–≤–∏—Ç—å UTF-8 decoder] --> B[–î–æ–±–∞–≤–∏—Ç—å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é SSE]
    B --> C[–ò—Å–ø—Ä–∞–≤–∏—Ç—å error handling]
    C --> D[–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å OpenWebUI]
```

### –≠—Ç–∞–ø 2: –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (2-3 –¥–Ω—è)
```mermaid
graph LR
    A[Stream format detection] --> B[SSE validation]
    B --> C[–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤]
    C --> D[Stress testing]
```

### –≠—Ç–∞–ø 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```mermaid
graph LR
    A[Backpressure] --> B[Metrics]
    B --> C[Full OpenAI compatibility]
```

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –¢–µ—Å—Ç 1: –†–∞–∑—Ä—ã–≤ UTF-8 —Å–∏–º–≤–æ–ª–æ–≤
```python
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å emoji –∏ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
# –û–∂–∏–¥–∞–Ω–∏–µ: —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å—Ç—Ä–∏–º –±–µ–∑ –æ–±—Ä—ã–≤–æ–≤
text = "–ü—Ä–∏–≤–µ—Ç! üëã –ö–∞–∫ –¥–µ–ª–∞? üöÄ"
```

### –¢–µ—Å—Ç 2: –î–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
```python
# –ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç–≤–µ—Ç >5000 —Ç–æ–∫–µ–Ω–æ–≤
# –û–∂–∏–¥–∞–Ω–∏–µ: –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –æ–±—Ä—ã–≤–æ–≤
prompt = "–ù–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç—å—é –Ω–∞ 3000 —Å–ª–æ–≤ –æ..."
```

### –¢–µ—Å—Ç 3: –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å –º–∞–ª—ã–º–∏ —á–∞–Ω–∫–∞–º–∏ (1-10 –±–∞–π—Ç)
# –û–∂–∏–¥–∞–Ω–∏–µ: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø–∞—Ä—Å–∏–Ω–≥
```

### –¢–µ—Å—Ç 4: –û—à–∏–±–∫–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
```python
# –ü—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ (rate limit, invalid token)
# –û–∂–∏–¥–∞–Ω–∏–µ: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –æ—à–∏–±–∫–∏ –±–µ–∑ [DONE]
```

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### Code Review Checklist:
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è incremental UTF-8 decoder –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∏–º–æ–≤
- [ ] –ï—Å—Ç—å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö SSE/JSON —Å—Ç—Ä–æ–∫
- [ ] Error handling –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç [DONE] –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
- [ ] –¢–∞–π–º–∞—É—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
- [ ] –§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å OpenAI API

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production:
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö UnicodeDecodeError —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –æ–±–æ—Ä–≤–∞–Ω–Ω—ã–º —Å—Ç—Ä–∏–º–∞–º
- [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ JSONDecodeError
- [ ] Dashboard —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Server-Sent Events spec](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [OpenAI Streaming API](https://platform.openai.com/docs/api-reference/streaming)
- [Python codecs.IncrementalDecoder](https://docs.python.org/3/library/codecs.html#codecs.IncrementalDecoder)
- [OpenWebUI GitHub](https://github.com/open-webui/open-webui)

---

## üìå –í—ã–≤–æ–¥—ã

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ–±—Ä—ã–≤–æ–≤ —Å—Ç—Ä–∏–º–∞ –ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö - **–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö UTF-8 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –∏ SSE/JSON —Å—Ç—Ä–æ–∫**.

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
- ‚úÖ –¢–µ–∫—Å—Ç —á–∏—Å—Ç–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (1 –±–∞–π—Ç –Ω–∞ —Å–∏–º–≤–æ–ª)
- ‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–¥–∞–µ—Ç –±–æ–ª—å—à–∏–µ —á–∞–Ω–∫–∏ (–ø–æ–ª–Ω—ã–µ SSE —Å–æ–±—ã—Ç–∏—è)
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å OpenWebUI –∏ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ —ç—Ç–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è ‚Üí **–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞**.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º (1-3) –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å OpenWebUI.